<!DOCTYPE html >
<html>
<head>
	<title></title>
	<script src="oauth/oauth.js"></script>
	<script src="oauth/sha1.js"></script>
	<script src="http://code.jquery.com/jquery-1.8.3.min.js"></script>
	<script>
		var EVERNOTE_SERVER = "https://sandbox.evernote.com",
			OAUTH_CONSUMER_KEY = "ranbena",
			OAUTH_CONSUMER_SECRET = "a4d80c714dcd93c3",
			OAUTH_TOKEN_SECRET = "",
			NOTESTORE_HOST = EVERNOTE_SERVER,
			NOTESTORE_PORT = "443",
			NOTESTORE_PROTOCOL = "https",
			OAUTH_SIGNATURE_METHOD = "HMAC-SHA1",
			NOTES_APP_CALLBACK_URL = "file://localhost/Users/ranbena/workspace/doat/ffos-notes/js-binary/testJsThrift.html",
			REQUEST_TOKEN_URL = EVERNOTE_SERVER+"/oauth",
			ACCESS_TOKEN_URL = EVERNOTE_SERVER+"/oauth",
			AUTHORIZATION_URL = EVERNOTE_SERVER+"/OAuth.action";

		function signForm(form) {
			var accessor = { 
		    	consumerSecret: OAUTH_CONSUMER_SECRET,
		    	tokenSecret: OAUTH_TOKEN_SECRET
		    };
		    var message = {
		    	action: REQUEST_TOKEN_URL,
		    	method: "POST",
				parameters: [
					["oauth_consumer_key", OAUTH_CONSUMER_KEY],
					["oauth_signature_method", OAUTH_SIGNATURE_METHOD],
					["oauth_timestamp", ""],
					["oauth_nonce", ""],
					["oauth_signature", ""],
					["oauth_callback", NOTES_APP_CALLBACK_URL]
				]
		    };

		    OAuth.setTimestampAndNonce(message);
		    OAuth.SignatureMethod.sign(message, accessor);

		    var parameterMap = OAuth.getParameterMap(message.parameters);
		    /*var redirectUrl = ACCESS_TOKEN_URL+"?";
		    for (var p in parameterMap) {
		        var input = document.createElement("input");
		        input.type = "hidden";
		        input.name = p;
		        input.value = parameterMap[p];
		        form.appendChild(input);
		    }
		    return true;*/

		    $.ajax({
		    	"type": "post",
		    	"url": ACCESS_TOKEN_URL,
		    	"data": parameterMap,
		    	"success": function() {
		    		alert(1);
		    	},
		    	"error": function() {
		    		alert(0);
		    	}
		    });
		}

		function getTokens(consumerName) {
		    var accessor = { 
		    	consumerKey: OAUTH_CONSUMER_KEY,
		    	consumerSecret: OAUTH_CONSUMER_SECRET,
		    	tokenSecret: OAUTH_TOKEN_SECRET,
		    	serviceProvider: {
		    		accessTokenUrl: ACCESS_TOKEN_URL,
		    		requestTokenURL: REQUEST_TOKEN_URL
		    	}
		    };
		    var message = {
		        method: "post",
		        action: accessor.serviceProvider.requestTokenURL,
		    	parameters: [["scope", "http://www.google.com/m8/feeds/"]]
		    };
		    var requestBody = OAuth.formEncode(message.parameters);
		    OAuth.completeRequest(message, accessor);
		    var authorizationHeader = OAuth.getAuthorizationHeader("", message.parameters);
		    var requestToken = new XMLHttpRequest();
		    requestToken.onreadystatechange = function receiveRequestToken() {
		        if (requestToken.readyState == 4) {
		            var dump = requestToken.status+" "+requestToken.statusText
		                  +"\n"+requestToken.getAllResponseHeaders()
		                  +"\n"+requestToken.responseText;
		            if (confirm(dump)) {
		                var results = OAuth.decodeForm(requestToken.responseText);
		                message = {method: "post", action: accessor.serviceProvider.accessTokenURL};
		                OAuth.completeRequest(message,
		                    { consumerKey   : accessor.consumerKey
		                    , consumerSecret: accessor.consumerSecret
		                    , token         : OAuth.getParameter(results, "oauth_token")
		                    , tokenSecret   : OAuth.getParameter(results, "oauth_token_secret")
		                    });
		                var requestAccess = new XMLHttpRequest();
		                requestAccess.onreadystatechange = function receiveAccessToken() {
		                    if (requestAccess.readyState == 4) {
		                        alert(requestAccess.status+" "+requestAccess.statusText
		                              +"\n"+requestAccess.getAllResponseHeaders()
		                              +"\n"+requestAccess.responseText);
		                    }
		                };
		                requestAccess.open(message.method, message.action, true); 
		                requestAccess.setRequestHeader("Authorization", OAuth.getAuthorizationHeader("", message.parameters));
		                requestAccess.send();
		            }
		        }
		    };
		    requestToken.open(message.method, message.action, true); 
		    requestToken.setRequestHeader("Authorization", authorizationHeader);
		    requestToken.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
		    requestToken.send(requestBody);
		}

		signForm();
	</script>
</head>
<body>
</body>
</html>